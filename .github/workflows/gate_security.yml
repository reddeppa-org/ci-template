name: Security Gating Workflow

on:
  workflow_call:
    inputs:
      repo_owner:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    secrets:
      pat_token:
        required: true

jobs:
  gate-security:
    runs-on: ubuntu-latest
    steps:

      - name: Validate CodeQL alerts (medium and above)
        run: |
          echo "Checking CodeQL alerts..."
          page=1
          per_page=100  # Max allowed by GitHub
          all_alerts="[]"

          while true; do
            response=$(curl -s -H "Authorization: Bearer ${{ secrets.pat_token }}" \
              "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/code-scanning/alerts?state=open&per_page=$per_page&page=$page")

            # Validate it's an array
            if ! echo "$response" | jq -e 'type == "array"' > /dev/null; then
              echo "âš ï¸ Unexpected response. API error:"
              echo "$response" | jq '.message // "No message available."' || echo "$response"
              exit 1
            fi

            # Merge alerts into all_alerts
            all_alerts=$(jq -s '.[0] + .[1]' <(echo "$all_alerts") <(echo "$response"))

            # Stop if fewer than requested entries returned (end of pagination)
            count=$(echo "$response" | jq 'length')
            if [ "$count" -lt "$per_page" ]; then
              break
            fi

            ((page++))
          done

          # Filter and write to file
          echo "$all_alerts" | jq '[.[] | select(.rule.severity == "medium" or .rule.severity == "high" or .rule.severity == "critical")]' > codeql_alerts.json

          count=$(jq length codeql_alerts.json)
          echo "Found $count medium+ severity CodeQL alerts"
          if [ "$count" -gt 0 ]; then
            echo "âŒ Failing due to CodeQL vulnerabilities"
            exit 1
          fi

      - name: Validate Dependabot alerts
        run: |
          echo "Checking Dependabot alerts..."
          curl -s -H "Authorization: Bearer ${{ secrets.pat_token }}" \
            "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/dependabot/alerts?state=open" \
            | jq '[.[]]' > dependabot_alerts.json

          count=$(jq length dependabot_alerts.json)
          echo "Found $count open Dependabot alerts"
          if [ "$count" -gt 0 ]; then
            echo "âŒ Failing due to open Dependabot vulnerabilities"
            exit 1
          fi

      - name: Validate Secret Scanning alerts
        run: |
          echo "Checking secret scanning alerts..."
          curl -s -H "Authorization: Bearer ${{ secrets.pat_token }}" \
            "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/secret-scanning/alerts?state=open" \
            | jq '[.[]]' > secret_alerts.json

          count=$(jq length secret_alerts.json)
          echo "Found $count open secret scanning alerts"
          if [ "$count" -gt 0 ]; then
            echo "âŒ Failing due to secret leaks"
            exit 1
          fi

      - name: âœ… All security checks passed
        run: echo "ğŸ‰ No blocking security issues found"