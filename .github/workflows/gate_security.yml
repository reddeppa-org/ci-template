name: Security Gating Workflow

on:
  workflow_call:
    inputs:
      repo_owner:
        required: true
        type: string
      repo_name:
        required: true
        type: string
    secrets:
      pat_token:
        required: true

jobs:
  gate-security:
    runs-on: ubuntu-latest
    steps:

      - name: Validate CodeQL alerts (medium and above)
        env:
         GH_TOKEN: ${{ secrets.pat_token }}
        run: |
          echo "Checking CodeQL alerts with GitHub CLI..."

          #gh auth login --with-token < ${{ secrets.pat_token }}

          repo="${{ inputs.repo_name }}"
          per_page=100
          page=1
          all_alerts="[]"
          echo "repos/$repo/code-scanning/alerts"
          while true; do
            response=$(gh api -X get "repos/$repo/code-scanning/alerts" --paginate -H "Accept: application/vnd.github+json" -F state=open -F per_page=100 -F page=1 --jq '.')

            # Ensure it's a JSON array
            if ! echo "$response" | jq -e 'type == "array"' > /dev/null; then
              echo "‚ö†Ô∏è Invalid response. Here's the message:"
              echo "$response" | jq '.message // "No message available."' || echo "$response"
              exit 1
            fi

            # Merge with previous alerts
            all_alerts=$(jq -s '.[0] + .[1]' <(echo "$all_alerts") <(echo "$response"))

            # Break if last page
            if [ "$(echo "$response" | jq 'length')" -lt "$per_page" ]; then
              break
            fi

            ((page++))
          done

          # Filter alerts with medium+ severity
          echo "$all_alerts" | jq '[.[] | select(.rule.security_severity_level == "medium" or .rule.security_severity_level == "high" or .rule.security_severity_level == "critical")]' > codeql_alerts.json

          count=$(jq length codeql_alerts.json)
          echo "Found $count medium+ severity CodeQL alerts"
          if [ "$count" -gt 0 ]; then
            echo "‚ùå Failing due to CodeQL vulnerabilities"
            #exit 1
          fi

      - name: Validate Dependabot alerts
        run: |
          echo "üîç Checking Dependabot alerts using GitHub CLI..."

          gh api "repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/dependabot/alerts" \
            -H "Authorization: Bearer ${{ secrets.pat_token }}" \
            -F state=open \
            --paginate \
            --jq '.' > dependabot_alerts.json

          count=$(jq length dependabot_alerts.json)
          echo "üì¶ Found $count open Dependabot alerts"

          if [ "$count" -gt 0 ]; then
            echo "‚ùå Failing due to open Dependabot vulnerabilities"
            exit 1
          fi

      - name: Validate Secret Scanning alerts
        run: |
          echo "Checking secret scanning alerts..."
          curl -s -H "Authorization: Bearer ${{ secrets.pat_token }}" \
            "https://api.github.com/repos/${{ inputs.repo_owner }}/${{ inputs.repo_name }}/secret-scanning/alerts?state=open" \
            | jq '[.[]]' > secret_alerts.json

          count=$(jq length secret_alerts.json)
          echo "Found $count open secret scanning alerts"
          if [ "$count" -gt 0 ]; then
            echo "‚ùå Failing due to secret leaks"
            exit 1
          fi

      - name: ‚úÖ All security checks passed
        run: echo "üéâ No blocking security issues found"